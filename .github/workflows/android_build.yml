name: Android Build

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'バージョン番号 (例: 1.7.5)'
        required: true
        default: '1.7.5'
      build_type:
        description: 'ビルドタイプ'
        required: true
        default: 'apk'
        type: choice
        options:
          - apk
          - aab
          - both
      create_release:
        description: 'GitHub Releaseを作るか'
        required: true
        default: 'publish'
        type: choice
        options:
          - no
          - draft
          - publish
      force_update:
        description: '強制アップデートにする'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-android:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # バージョンコード生成（yyMMdd + 連番）
      - name: Generate version code
        id: version
        run: |
          VERSION_NAME="${{ github.event.inputs.version }}"
          DATE=$(date +'%y%m%d')
          COUNTER_FILE=".version_counter"
          
          # 連番の読み込み・更新
          if [ -f "$COUNTER_FILE" ]; then
            COUNT=$(cat "$COUNTER_FILE")
          else
            COUNT=0
          fi
          COUNT=$((COUNT + 1))
          printf "%02d" "$COUNT" > "$COUNTER_FILE"
          
          VERSION_CODE="${DATE}$(cat $COUNTER_FILE)"
          TAG="v${VERSION_NAME}-${VERSION_CODE}"
          
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Generated: $VERSION_NAME (Build $VERSION_CODE)"

      - name: Commit version counter
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .version_counter
          git diff --staged --quiet || git commit -m "chore: bump version counter [skip ci]"
          git push || true

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true
          cache-key: flutter-android-${{ hashFiles('**/pubspec.lock') }}

      # バージョン情報をソースに反映
      - name: Update version in files
        env:
          VERSION_NAME: ${{ steps.version.outputs.version_name }}
          VERSION_CODE: ${{ steps.version.outputs.version_code }}
        run: |
          # pubspec.yaml
          sed -i "s/^version: .*/version: $VERSION_NAME+$VERSION_CODE/" pubspec.yaml
          
          # build.gradle.kts
          sed -i "s/versionCode = .*/versionCode = $VERSION_CODE/" android/app/build.gradle.kts
          sed -i "s/versionName = .*/versionName = \"$VERSION_NAME\"/" android/app/build.gradle.kts

      - name: Create Keystore
        run: echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/release.keystore

      - name: Create key.properties
        run: |
          cat > android/key.properties << EOF
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          storeFile=release.keystore
          EOF

      - name: Create .env file
        run: |
          cat > .env << EOF
          SUPABASE_URL=${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}
          EOF

      - name: Get dependencies
        run: flutter pub get

      - name: Build APK
        if: github.event.inputs.build_type == 'apk' || github.event.inputs.build_type == 'both'
        run: flutter build apk --release

      - name: Build AAB
        if: github.event.inputs.build_type == 'aab' || github.event.inputs.build_type == 'both'
        run: flutter build appbundle --release

      # Artifacts アップロード
      - name: Upload APK artifact
        if: github.event.inputs.build_type == 'apk' || github.event.inputs.build_type == 'both'
        uses: actions/upload-artifact@v4
        with:
          name: FavLog-apk
          path: build/app/outputs/flutter-apk/app-release.apk
          retention-days: 30

      - name: Upload AAB artifact
        if: github.event.inputs.build_type == 'aab' || github.event.inputs.build_type == 'both'
        uses: actions/upload-artifact@v4
        with:
          name: FavLog-aab
          path: build/app/outputs/bundle/release/app-release.aab
          retention-days: 90

      # リリースノート生成
      - name: Generate release notes
        if: github.event.inputs.create_release != 'no'
        id: notes
        run: |
          NOTES=$(git log -10 --pretty=format:"- %s" || echo "New release")
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # GitHub Release 作成
      - name: Create GitHub Release
        id: create_release
        if: github.event.inputs.create_release != 'no'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: FavLog v${{ steps.version.outputs.version_name }} (Build ${{ steps.version.outputs.version_code }})
          body: ${{ steps.notes.outputs.content }}
          draft: ${{ github.event.inputs.create_release == 'draft' }}
          files: |
            build/app/outputs/flutter-apk/app-release.apk
            build/app/outputs/bundle/release/app-release.aab
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # version.json 生成
      - name: Generate version.json
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          VERSION_NAME="${{ steps.version.outputs.version_name }}"
          VERSION_CODE="${{ steps.version.outputs.version_code }}"
          APK_URL="https://github.com/${{ github.repository }}/releases/download/${TAG}/app-release.apk"
          RELEASE_NOTES=$(git log -10 --pretty=format:"- %s" || echo "New release")
          FORCE_UPDATE="${{ github.event.inputs.force_update }}"
          
          jq -n \
            --arg v "$VERSION_NAME" \
            --arg vc "$VERSION_CODE" \
            --arg url "$APK_URL" \
            --arg notes "$RELEASE_NOTES" \
            --argjson force "$FORCE_UPDATE" \
            '{
              version: $v,
              versionCode: ($vc|tonumber),
              downloadUrl: $url,
              releaseNotes: $notes,
              minSupportedVersion: "0.0.1",
              forceUpdate: $force
            }' > version.json
          
          cat version.json

      # download.html 生成
      - name: Generate download.html
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          APK_URL="https://github.com/${{ github.repository }}/releases/download/${TAG}/app-release.apk"
          
          cat > download.html << EOF
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8">
            <meta http-equiv="refresh" content="0;url=${APK_URL}">
            <title>Downloading FavLog...</title>
          </head>
          <body>
            <p>ダウンロード中... <a href="${APK_URL}">こちらをクリック</a></p>
          </body>
          </html>
          EOF

      # GitHub Pages にデプロイ
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .
          publish_branch: gh-pages
          keep_files: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          include_files: |
            version.json
            download.html

      - name: Clean up secrets
        if: always()
        run: |
          rm -f android/release.keystore
          rm -f android/key.properties
          rm -f .env