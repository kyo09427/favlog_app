name: Android Build & Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'バージョン番号 (例: 1.7.5)'
        required: true
        default: '1.7.5'
      build_type:
        description: 'ビルドタイプ'
        required: true
        default: 'apk'
        type: choice
        options: [apk, aab, both]
      release_type:
        description: 'リリースタイプ'
        required: true
        default: 'publish'
        type: choice
        options: [none, draft, publish]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # バージョン情報生成
      - name: Generate version info
        id: version
        run: |
          VERSION_NAME="${{ github.event.inputs.version }}"
          DATE=$(date +'%y%m%d')
          COUNTER_FILE=".version_counter"
          COUNT=$([ -f "$COUNTER_FILE" ] && cat "$COUNTER_FILE" || echo 0)
          COUNT=$((COUNT + 1))
          printf "%02d" "$COUNT" > "$COUNTER_FILE"
          VERSION_CODE="${DATE}$(cat $COUNTER_FILE)"
          
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "tag=v${VERSION_NAME}-${VERSION_CODE}" >> $GITHUB_OUTPUT
          echo "Generated: $VERSION_NAME ($VERSION_CODE)"

      - name: Commit version counter
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .version_counter
          git diff --staged --quiet || git commit -m "chore: bump version counter [skip ci]"
          git push || true

      # Flutter環境セットアップ
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true
          cache-key: flutter-android-${{ hashFiles('**/pubspec.lock') }}

      # プロジェクト設定
      - name: Configure project
        env:
          VERSION_NAME: ${{ steps.version.outputs.version_name }}
          VERSION_CODE: ${{ steps.version.outputs.version_code }}
        run: |
          # バージョン更新
          sed -i "s/versionName = .*/versionName = \"$VERSION_NAME\"/" android/app/build.gradle.kts
          sed -i "s/versionCode = .*/versionCode = $VERSION_CODE/" android/app/build.gradle.kts
          sed -i "s/^version: .*/version: $VERSION_NAME+$VERSION_CODE/" pubspec.yaml
          
          # Keystore作成
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > android/release.keystore
          
          # key.properties作成
          cat > android/key.properties << EOF
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          storeFile=release.keystore
          EOF
          
          # .env作成
          cat > .env << EOF
          SUPABASE_URL=${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}
          EOF

      - name: Get dependencies
        run: flutter pub get

      # ビルド
      - name: Build APK
        if: inputs.build_type == 'apk' || inputs.build_type == 'both'
        run: flutter build apk --release --no-tree-shake-icons

      - name: Build AAB
        if: inputs.build_type == 'aab' || inputs.build_type == 'both'
        run: flutter build appbundle --release

      # リリース作成
      - name: Generate release notes
        if: inputs.release_type != 'none'
        id: notes
        run: |
          NOTES=$(git log -10 --pretty=format:"- %s" || echo "New release")
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        if: inputs.release_type != 'none'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: FavLog v${{ steps.version.outputs.version_name }} (Build ${{ steps.version.outputs.version_code }})
          body: ${{ steps.notes.outputs.content }}
          draft: ${{ inputs.release_type == 'draft' }}
          files: |
            build/app/outputs/flutter-apk/app-release.apk
            build/app/outputs/bundle/release/app-release.aab
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # アップデート情報生成
      - name: Generate update metadata
        id: metadata
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          APK_URL="https://github.com/${{ github.repository }}/releases/download/${TAG}/app-release.apk"
          
          jq -n \
            --arg v "${{ steps.version.outputs.version_name }}" \
            --arg vc "${{ steps.version.outputs.version_code }}" \
            --arg url "$APK_URL" \
            --arg notes "${{ steps.notes.outputs.content }}" \
            '{
              version: $v,
              versionCode: ($vc|tonumber),
              downloadUrl: $url,
              releaseNotes: $notes,
              minSupportedVersion: "0.0.1",
              forceUpdate: false
            }' > version.json
          
          cat > download.html << EOF
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8">
            <meta http-equiv="refresh" content="0;url=${APK_URL}">
            <title>Downloading FavLog...</title>
          </head>
          <body>
            <p>ダウンロード中... <a href="${APK_URL}">こちらをクリック</a></p>
          </body>
          </html>
          EOF

      - name: Upload metadata artifacts
        uses: actions/upload-artifact@v4
        with:
          name: update-metadata
          path: |
            version.json
            download.html
          retention-days: 1

  deploy-metadata:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Download metadata
        uses: actions/download-artifact@v4
        with:
          name: update-metadata

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .
          publish_branch: gh-pages
          keep_files: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'