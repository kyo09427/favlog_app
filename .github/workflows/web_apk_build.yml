name: Deploy Web

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/workflows/**'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true
          cache-key: flutter-web-${{ hashFiles('**/pubspec.lock') }}

      - name: Create .env
        run: |
          cat > .env << EOF
          SUPABASE_URL=${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}
          EOF

      - name: Get dependencies
        run: flutter pub get

      - name: Build Web
        run: |
          flutter config --enable-web
          flutter build web --release --base-href /favlog_app/ --no-tree-shake-icons

      - name: Create 404 redirect
        run: |
          cat > build/web/404.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8">
            <title>Redirecting...</title>
            <script>
              const path = window.location.pathname.replace('/favlog_app', '');
              const target = path === '/404.html' ? '/favlog_app/' : '/favlog_app/' + path.slice(1);
              window.location.replace(target + window.location.search + window.location.hash);
            </script>
          </head>
          <body><p>リダイレクト中...</p></body>
          </html>
          EOF

      # 最新のリリース情報を取得してversion.jsonを生成
      - name: Generate version.json from latest release
        run: |
          LATEST=$(curl -sH "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases/latest")
          
          VERSION=$(echo "$LATEST" | jq -r '.tag_name // "v0.0.0"' | sed 's/^v//' | cut -d'-' -f1)
          VERSION_CODE=$(echo "$LATEST" | jq -r '.tag_name // "v0.0.0-0"' | grep -oP '\-\K[0-9]+$' || echo "0")
          APK_URL=$(echo "$LATEST" | jq -r '.assets[] | select(.name | endswith(".apk")) | .browser_download_url // ""')
          NOTES=$(echo "$LATEST" | jq -r '.body // "Latest release"')
          
          jq -n \
            --arg v "$VERSION" \
            --arg vc "$VERSION_CODE" \
            --arg url "$APK_URL" \
            --arg notes "$NOTES" \
            '{
              version: $v,
              versionCode: ($vc|tonumber),
              downloadUrl: $url,
              releaseNotes: $notes,
              minSupportedVersion: "0.0.1",
              forceUpdate: false
            }' > build/web/version.json
          
          # download.html生成
          cat > build/web/download.html << EOF
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8">
            <meta http-equiv="refresh" content="0;url=${APK_URL}">
            <title>Downloading FavLog...</title>
          </head>
          <body>
            <p>ダウンロード中... <a href="${APK_URL}">こちらをクリック</a></p>
          </body>
          </html>
          EOF

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./build/web
          force_orphan: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'