# 技術詳細

このドキュメントでは、FavLogアプリケーションで使用している技術的な実装の詳細について説明します。

## 目次

- [プラットフォーム別画像最適化](#プラットフォーム別画像最適化)
- [Row Level Security (RLS)](#row-level-security-rls)
- [エラーハンドリング](#エラーハンドリング)
- [レスポンシブデザイン](#レスポンシブデザイン)

## プラットフォーム別画像最適化

FavLogアプリでは、プラットフォームに応じて最適な画像形式を自動選択し、ストレージコストとパフォーマンスを最適化しています。

### 画像形式の自動選択

- **ネイティブアプリ（Android/iOS）**: WebP形式
  - ファイルサイズが20-30%削減
  - 高い圧縮率と優れた画質を両立
  - モバイルデバイスのストレージを節約
- **Webアプリ**: JPEG形式
  - ブラウザ間の互換性を確保
  - 広範なサポートによる安定性

### 実装の詳細

画像アップロード時に、`kIsWeb`フラグを使用してプラットフォームを判定し、適切なファイル拡張子とContent-Typeを動的に設定します：

```dart
// プラットフォームに応じて拡張子とContent-Typeを設定
final fileExtension = kIsWeb ? 'jpg' : 'webp';
final contentType = kIsWeb ? 'image/jpeg' : 'image/webp';
```

この実装により、以下のコントローラーで画像最適化が適用されます：

- `edit_product_controller.dart` - 商品画像の編集
- `add_review_controller.dart` - 新規レビュー投稿時の商品画像
- `profile_screen_controller.dart` - プロフィールアバター画像

## Row Level Security (RLS)

Supabaseの**Row Level Security（行レベルセキュリティ）**機能を活用し、データへのアクセスを細かく制御しています。

### 商品編集のセキュリティ

- ユーザーは**自分が作成した商品のみ**編集可能
- 他のユーザーの商品を編集しようとすると、明確なエラーメッセージが表示される
- データベースレベルでセキュリティが保証されているため、APIの不正利用を防止

### RLSポリシーの検証

アプリケーションコードでは、更新操作の結果を`.select()`で取得し、実際に更新された行数を確認することで、RLSポリシーによる拒否を検出します：

```dart
// 更新を実行して結果を取得
final result = await _supabaseClient
    .from('products')
    .update({...})
    .eq('id', product.id)
    .select();

// 更新された行が0行の場合はRLSポリシーで拒否された可能性が高い
if (result.isEmpty) {
  throw Exception('商品の更新に失敗しました。この商品を編集する権限がない可能性があります。');
}
```

この実装により、セキュリティとユーザーエクスペリエンスの両立を実現しています。

### 通知のセキュリティ

`notifications`テーブルと`user_settings`テーブルにも厳格なRLSポリシーが適用されており：

- ユーザーは**自分の通知のみ**閲覧・更新・削除可能
- ユーザーは**自分の設定のみ**閲覧・更新可能
- 他のユーザーへの通知送信はすべての認証済みユーザーに許可（新規レビュー通知などのため）

## エラーハンドリング

FavLogアプリでは、統一されたエラーハンドリングシステムを実装しています。

### 統一エラーダイアログ

ネットワークエラー、認証エラーなど、エラーの種類に応じた適切なメッセージを統一的なダイアログで表示します。

### 主なエラーケース

- **ログイン/登録失敗**: 認証エラーメッセージを表示
- **画像選択失敗**: ファイル選択エラーを表示
- **レビュー投稿・更新失敗**: ネットワークまたはバリデーションエラーを表示
- **JWT有効期限切れ**: 自動ログアウトと再認証誘導

## レスポンシブデザイン

モバイル・タブレット・Webなど、デバイスの画面幅に応じた最適なレイアウトを提供しています。

### ホーム画面のレイアウト切り替え

画面幅に応じてレビューの一覧表示が動的に切り替わります：

- **スマートフォン（狭い画面）**: `ListView` - レビューが縦一列に表示
- **タブレット・Web（広い画面）**: `GridView` - レビューが複数列に表示

### 画像表示の最適化

- **画像キャッシュ**（`CachedNetworkImage`）によるパフォーマンス向上
- 読み込み中の**プレースホルダー**（Shimmer効果）
- エラー時の**フォールバック画像**表示
- **画像の縦横比を維持**して表示（不自然な引き伸ばしや切り取りを防止）

---

技術詳細の詳細については、[メインREADME](../README.md)に戻ってください。
